\begin{figure}[h!]
    \renewcommand{\smname}{\smn}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Secure channel creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{3.5\instdist}

                \declinst{cli}{C}{}
                \declinst{intruder}{DiscoreryEndpoint}{}
                \declinst{sess}{S}{}

                \mess{GetEndpointsRequest}[b]{cli}{intruder}
                \nextlevel[1.5]

                \mess{SP, \smname, UP, pk(S)}[b]{intruder}{cli}
                \nextlevel[1.5]
                
                \action*{Validates pk(S)}{cli}
                \nextlevel[2]
                
                \action*{Generates N$_{C}$}{cli}
                \nextlevel[2]

                \mess{pk(C), \sm{SP, $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{cli}{sess}
                \nextlevel[2]

                \action*{Validates pk(C) }{sess}
                \nextlevel[2]

                \action*{Generates N$_{S}$ }{sess}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
                    \nextlevel[2]
                }

                \mess{\sm{$g^{N_{S}}$}{pk(C)}{sk(S)}}[b]{sess}{cli}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{cli}$ = $(g^{N_{S}})^{N_{C}}$}{cli}
                    \nextlevel[2]
                }
            \end{msc}
        \end{postscript}
    }
    \caption{OPC-UA Secure Channel None}
\end{figure}


\begin{figure}[h!]
    \renewcommand{\smname}{\sms}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Secure channel creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{3.5\instdist}

                \declinst{cli}{C}{}
                \declinst{intruder}{DiscoreryEndpoint}{}
                \declinst{sess}{S}{}

                \mess{GetEndpointsRequest}[b]{cli}{intruder}
                \nextlevel[1.5]

                \mess{SP, \smname, UP, pk(S)}[b]{intruder}{cli}
                \nextlevel[1.5]
                
                \action*{Validates pk(S)}{cli}
                \nextlevel[2]
                
                \action*{Generates N$_{C}$}{cli}
                \nextlevel[2]

                \mess{pk(C), \sm{SP, $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{cli}{sess}
                \nextlevel[2]

                \action*{Validates pk(C) }{sess}
                \nextlevel[2]

                \action*{Generates N$_{S}$ }{sess}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
                    \nextlevel[2]
                }

                \mess{\sm{$g^{N_{S}}$}{pk(C)}{sk(S)}}[b]{sess}{cli}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{cli}$ = $(g^{N_{S}})^{N_{C}}$}{cli}
                    \nextlevel[2]
                }
            \end{msc}
        \end{postscript}
    }
    \caption{OPC-UA Secure Channel Sign}
\end{figure}


\begin{figure}[h!]
    \renewcommand{\smname}{\smse}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Secure channel creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{3.5\instdist}

                \declinst{cli}{C}{}
                \declinst{intruder}{DiscoreryEndpoint}{}
                \declinst{sess}{S}{}

                \mess{GetEndpointsRequest}[b]{cli}{intruder}
                \nextlevel[1.5]

                \mess{SP, \smname, UP, pk(S)}[b]{intruder}{cli}
                \nextlevel[1.5]
                
                \action*{Validates pk(S)}{cli}
                \nextlevel[2]
                
                \action*{Generates N$_{C}$}{cli}
                \nextlevel[2]

                \mess{pk(C), \sm{SP, $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{cli}{sess}
                \nextlevel[2]

                \action*{Validates pk(C) }{sess}
                \nextlevel[2]

                \action*{Generates N$_{S}$ }{sess}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
                    \nextlevel[2]
                }

                \mess{\sm{$g^{N_{S}}$}{pk(C)}{sk(S)}}[b]{sess}{cli}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{cli}$ = $(g^{N_{S}})^{N_{C}}$}{cli}
                    \nextlevel[2]
                }
            \end{msc}
        \end{postscript}
    }
    \caption{OPC-UA Secure Channel SignAndEncrypt}
\end{figure}

Objectives:
\begin{enumerate}
    \item\label{item:sc_sec_cli} Secrecy of $K_{cli}$ shared between C and S
    \item\label{item:sc_sec_srv} Secrecy of $K_{src}$ shared between C and S
    \item\label{item:sc_auth_cli} Authentication on $g^{Nc}$
    \item\label{item:sc_auth_srv} Authentication on $g^{Ns}$
\end{enumerate}

\subsection{Results}

\begin{table}[h!]
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}
        \hline
        \multicolumn{2}{|c}{Security modes} & \multicolumn{4}{|c|}{Objectives} \\
        \hline
        Client          & S   & \ref{item:sc_sec_cli} & \ref{item:sc_sec_srv} & \ref{item:sc_auth_cli}    & \ref{item:sc_auth_srv}    \\
        \hline
        None            & None              & \UNSAFE{}               & \UNSAFE{}               & \UNSAFE{}                   & \UNSAFE{}                   \\ 
        \hline
        None            & Sign              & \UNSAFE{}               & \SAFE{}                 & \SAFE{}                     & \UNSAFE{}                   \\ 
        \hline
        None            & SignAndEncrypt    & \UNSAFE{}               & \SAFE{}                 & \SAFE{}                     & \UNSAFE{}                   \\ 
        \hline
        Sign            & None              & \SAFE{}                 & \UNSAFE{}               & \UNSAFE{}                   & \UNSAFE{}                   \\ 
        \hline
        Sign            & Sign              & \SAFE{}                 & \SAFE{}                 & \UNSAFE{}                   & \UNSAFE{}                   \\ 
        \hline
        Sign            & SignAndEncrypt    & \SAFE{}                 & \SAFE{}                 & \UNSAFE{}                   & \UNSAFE{}                   \\ 
        \hline
        SignAndEncrypt  & None              & \SAFE{}                 & \UNSAFE{}               & \UNSAFE{}                   & \UNSAFE{}                   \\ 
        \hline
        SignAndEncrypt  & Sign              & \SAFE{}                 & \SAFE{}                 & \UNSAFE{}                   & \UNSAFE{}                   \\ 
        \hline
        SignAndEncrypt  & SignAndEncrypt    & \SAFE{}                 & \SAFE{}                 & \UNSAFE{}                   & \UNSAFE{}                   \\ 
        \hline
    \end{tabular}
    \caption{Results}
\end{table}

Exemple d'attaque :
\begin{figure}[h!]
    \renewcommand{\smname}{\smse}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Secure channel creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{3.5\instdist}

                \declinst{cli}{C}{}
                \declinst{intruder}{I}{}
                \declinst{sess}{S}{}

                \mess{GetEndpointsRequest}[b]{cli}{intruder}
                \nextlevel[1.5]

                \mess{SP, \smname, UP, pk(I)}[b]{intruder}{cli}
                \nextlevel[1.5]
                
                \action*{Validates pk(I)}{cli}
                \nextlevel[2]
                
                \action*{Generates N$_{C}$}{cli}
                \nextlevel[2]

                \mess{pk(C), \sm{SP, $g^{N_{C}}$}{pk(I)}{sk(C)}}[b]{cli}{intruder}
                \mess{pk(C), \sm{SP, $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{intruder}{sess}
                \nextlevel[2]

                \action*{Validates pk(C) }{sess}
                \nextlevel[2]

                \action*{Generates N$_{S}$ }{sess}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
                    \nextlevel[2]
                }

                \mess{\sm{$g^{N_{S}}$}{pk(C)}{sk(S)}}[b]{sess}{intruder}
            \end{msc}
        \end{postscript}
    }
    \caption{OPC-UA Secure Channel SignAndEncrypt}
\end{figure}

NB: Dans la plus part des attaques, le client parle avec un autre client, probl√®me ?\\
L'open secure channel request devrait contenir la pk du serveur dans la signature.
\begin{itemize}
    \item Le client atteste vouloir parler au serveur.
\end{itemize}
