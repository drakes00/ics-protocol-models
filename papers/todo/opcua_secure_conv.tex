%\newcommand{\gereq}{GetEndpointRequest}
%\newcommand{\geres}{GetEndpointResponse}
%\newcommand{\oscreq}{OpenSecureChannelRequest}
%\newcommand{\oscres}{OpenSecureChannelResponse}
\newcommand{\gereq}{GEReq}
\newcommand{\geres}{GERes}
\newcommand{\oscreq}{OSCReq}
\newcommand{\oscres}{OSCRes}


The {\em OpenSecureConversation} sub-protocol, aims to authenticate a client and
a server and allow them to generate a shared key for the later communications.
\opcua can be used with three security modes, namely {\em None}, {\em Sign} and
{\em SignAndEncrypt}.

\begin{itemize}
    \item SignAndEncrypt: claims to provide secrecy using symetric and
    assymetric encryption and both authentication and integrity through digital
    signatures.
    It is described in Figure \ref{fig:secure_conv_se}.

    \item Sign: same as {\em SignAndEncrypt} but without any encryption.
    Thus nonces are not used to generate a shared key but bring freshness to the
    messages.
%    Figure \ref{fig:secure_conv_sign} demonstrates this variant.

    \item None: does not provide any security.
    Using this security mode, the {\em OpenSecureConversation} sub-protocol does
    not serve much purpose but is used for compatibility.
%    Figure \ref{fig:secure_conv_none} presents this variant of the sub-protocol.
\end{itemize}

%\begin{figure}[htb]
%    \renewcommand{\smname}{\smn}
%    \resizebox{\textwidth}{!}{
%        \begin{postscript}
%            \begin{msc}{Secure channel creation}
%                \setlength{\envinstdist}{1.5\envinstdist}
%                \setlength{\instdist}{3.5\instdist}
%
%                \declinst{cli}{C}{}
%                \declinst{intruder}{DiscoreryEndpoint}{}
%                \declinst{sess}{S}{}
%
%                \mess{GetEndpointsRequest}[b]{cli}{intruder}
%                \nextlevel[1.5]
%
%                \mess{SP, \smname, UP, pk(S)}[b]{intruder}{cli}
%                \nextlevel[1.5]
%                
%                \action*{Validates pk(S)}{cli}
%                \nextlevel[2]
%                
%                \action*{Generates N$_{C}$}{cli}
%                \nextlevel[2]
%
%                \mess{pk(C), \sm{SP, $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{cli}{sess}
%                \nextlevel[2]
%
%                \action*{Validates pk(C) }{sess}
%                \nextlevel[2]
%
%                \action*{Generates N$_{S}$ }{sess}
%                \nextlevel[2]
%
%                \ifsmnotnone{%
%                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
%                    \nextlevel[2]
%                }
%
%                \mess{\sm{$g^{N_{S}}$}{pk(C)}{sk(S)}}[b]{sess}{cli}
%                \nextlevel[2]
%
%                \ifsmnotnone{%
%                    \action*{$K_{cli}$ = $(g^{N_{S}})^{N_{C}}$}{cli}
%                    \nextlevel[2]
%                }
%            \end{msc}
%        \end{postscript}
%    }
%    \caption{\opcua Secure Conversation None}
%    \label{fig:secure_conv_none}
%\end{figure}
%
%\begin{figure}[htb]
%    \renewcommand{\smname}{\sms}
%    \resizebox{\textwidth}{!}{
%        \begin{postscript}
%            \begin{msc}{Secure channel creation}
%                \setlength{\envinstdist}{1.5\envinstdist}
%                \setlength{\instdist}{3.5\instdist}
%
%                \declinst{cli}{C}{}
%                \declinst{intruder}{DiscoreryEndpoint}{}
%                \declinst{sess}{S}{}
%
%                \mess{GetEndpointsRequest}[b]{cli}{intruder}
%                \nextlevel[1.5]
%
%                \mess{SP, \smname, UP, pk(S)}[b]{intruder}{cli}
%                \nextlevel[1.5]
%                
%                \action*{Validates pk(S)}{cli}
%                \nextlevel[2]
%                
%                \action*{Generates N$_{C}$}{cli}
%                \nextlevel[2]
%
%                \mess{pk(C), \sm{SP, $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{cli}{sess}
%                \nextlevel[2]
%
%                \action*{Validates pk(C) }{sess}
%                \nextlevel[2]
%
%                \action*{Generates N$_{S}$ }{sess}
%                \nextlevel[2]
%
%                \ifsmnotnone{%
%                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
%                    \nextlevel[2]
%                }
%
%                \mess{\sm{$g^{N_{S}}$}{pk(C)}{sk(S)}}[b]{sess}{cli}
%                \nextlevel[2]
%
%                \ifsmnotnone{%
%                    \action*{$K_{cli}$ = $(g^{N_{S}})^{N_{C}}$}{cli}
%                    \nextlevel[2]
%                }
%            \end{msc}
%        \end{postscript}
%    }
%    \caption{\opcua Secure Conversation Sign}
%    \label{fig:secure_conv_sign}
%\end{figure}

\begin{figure}[htb]
    \renewcommand{\smname}{\smse}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Secure channel creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{3\instdist}

                \declinst{cli}{C}{}
                \declinst{intruder}{DiscoreryEndpoint}{}
                \declinst{sess}{S}{}

                \mess{\gereq}[b]{cli}{intruder}
                \nextlevel[1.5]

                \mess{\geres, pk(S), \smname, SP, UP}[b]{intruder}{cli}
                \nextlevel[1.5]
                
                \action*{Validates pk(S)}{cli}
                \nextlevel[2]
                
                \action*{Generates N$_{C}$}{cli}
                \nextlevel[2]

                \mess{pk(C), \sm{\oscreq, pk(C), $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{cli}{sess}
                \nextlevel[2]

                \action*{Validates pk(C) }{sess}
                \nextlevel[2]

                \action*{Generates N$_{S}$ }{sess}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
                    \nextlevel[2]
                }

                \mess{\sm{\oscres, $g^{N_{S}}$, ST, TTL}{pk(C)}{sk(S)}}[b]{sess}{cli}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{cli}$ = $(g^{N_{S}})^{N_{C}}$}{cli}
                    \nextlevel[2]
                }
            \end{msc}
        \end{postscript}
    }
    \caption{\opcua OpenSecureConversation sub-protocol}
    \label{fig:secure_conv_se}
\end{figure}

\subsection{Modelisation}

Normaly, a {\em GetEnpointRequest} would be answered by a list of session
endpoints with possibly different security modes.
For simplicity, we suppose that only one endpoint is answered.
Thus, to ensure completeness of our analysis, we verify all combinations of
security modes (\eg a client configured in {\em None} speaking with a server
configured in {\em SignAndEncrypt}, which would not be possible normaly).
This way we can verify if an attacker can exploit the security of a peer as an
oracle to mount an attack against another.
Moreover, thanks to the perfect encryption hypothesis (\TODO expliquer qq part),
we can abstract the security policy messages as we do not differentiate which
cryptographic primitives are used.

Objectives:
\begin{enumerate}
    \item\label{item:sc_sec_cli} Secrecy of $K_{cli}$ obtained by C.
    \item\label{item:sc_sec_srv} Secrecy of $K_{src}$ obtained by S.
    \item\label{item:sc_auth_cli} Authentication on $g^{Nc}$.
    \item\label{item:sc_auth_srv} Authentication on $g^{Ns}$.
\end{enumerate}

\subsection{Results}

We run \proverif on this protocol for each combination of the three security
modes of \opcua for each objective proposed.
Results are shown in Table \ref{tab:secure_conv_results}.

\begin{table}[htb]
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}
        \hline
        \multicolumn{2}{|c}{\opcua Security modes} & \multicolumn{4}{|c|}{Objectives} \\
        \hline
        C              & S              & Sec $K_{cli}$ & Sec $K_{srv}$ & Auth $g^{N_{S}}$  & Auth $g^{N_{C}}$  \\
        \hline                                                                                                 
        None           & None           & \UNSAFE       & \UNSAFE       & \UNSAFE           & \UNSAFE           \\ 
        \hline                                                                                                 
        None           & Sign           & \UNSAFE       & \SAFE         & \UNSAFE           & \SAFE             \\ 
        \hline                                                                                                 
        None           & SignAndEncrypt & \UNSAFE       & \SAFE         & \UNSAFE           & \SAFE             \\ 
        \hline                                                                                                 
        Sign           & None           & \SAFE         & \UNSAFE       & \UNSAFE           & \UNSAFE           \\ 
        \hline                                                                                                 
        Sign           & Sign           & \SAFE         & \SAFE         & \UNSAFE           & \UNSAFE           \\ 
        \hline                                                                                                 
        Sign           & SignAndEncrypt & \SAFE         & \SAFE         & \UNSAFE           & \UNSAFE           \\ 
        \hline                                                                                                 
        SignAndEncrypt & None           & \SAFE         & \UNSAFE       & \UNSAFE           & \UNSAFE           \\ 
        \hline                                                                                                 
        SignAndEncrypt & Sign           & \SAFE         & \SAFE         & \UNSAFE           & \UNSAFE           \\ 
        \hline                                                                                                 
        SignAndEncrypt & SignAndEncrypt & \SAFE         & \SAFE         & \UNSAFE           & \UNSAFE           \\ 
        \hline
    \end{tabular}
    \label{tab:secure_conv_results}
    \caption{Results}
\end{table}

Exemple d'attaque :
\begin{figure}[htb]
    \renewcommand{\smname}{\smse}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Secure channel creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{5.1\instdist}

                \declinst{cli}{C}{}
                \declinst{intruder}{I}{}
                \declinst{sess}{S}{}

                \mess{\gereq}[b]{cli}{intruder}
                \nextlevel[1.5]

                \mess{\geres, pk(I), \smname, SP, UP}[b]{intruder}{cli}
                \nextlevel[1.5]
                
                \action*{Validates pk(I)}{cli}
                \nextlevel[2]
                
                \action*{Generates N$_{C}$}{cli}
                \nextlevel[2]

                \mess{pk(C), \sm{\oscreq, pk(C), $g^{N_{C}}$}{pk(I)}{sk(C)}}[b]{cli}{intruder}
                \nextlevel[2]

                \mess{pk(C), \sm{\oscreq, pk(C), $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{intruder}{sess}
                \nextlevel[2]

                \action*{Validates pk(C) }{sess}
                \nextlevel[2]

                \action*{Generates N$_{S}$ }{sess}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
                    \nextlevel[2]
                }

                \mess{\sm{\oscres, $g^{N_{S}}$, ST, TTL}{pk(C)}{sk(S)}}[b]{sess}{intruder}
                \nextlevel[1.5]
            \end{msc}
        \end{postscript}
    }
    \caption{\opcua Secure Conversation SignAndEncrypt}
\end{figure}

\subsection{Fixed version}

\begin{figure}[htb]
    \renewcommand{\smname}{\smse}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Secure channel creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{3\instdist}

                \declinst{cli}{C}{}
                \declinst{intruder}{DiscoreryEndpoint}{}
                \declinst{sess}{S}{}

                \mess{\gereq}[b]{cli}{intruder}
                \nextlevel[1.5]

                \mess{\geres, pk(S), \smname, SP, UP}[b]{intruder}{cli}
                \nextlevel[1.5]
                
                \action*{Validates pk(S)}{cli}
                \nextlevel[2]
                
                \action*{Generates N$_{C}$}{cli}
                \nextlevel[2]

                \mess{pk(C), \sm{\oscreq, S, pk(C), $g^{N_{C}}$}{pk(S)}{sk(C)}}[b]{cli}{sess}
                \nextlevel[2]

                \action*{Validates pk(C) }{sess}
                \nextlevel[2]

                \action*{Generates N$_{S}$ }{sess}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{srv}$ = $(g^{N_{C}})^{N_{S}}$ }{sess}
                    \nextlevel[2]
                }

                \mess{\sm{\oscres, C, $g^{N_{S}}$, ST, TTL}{pk(C)}{sk(S)}}[b]{sess}{cli}
                \nextlevel[2]

                \ifsmnotnone{%
                    \action*{$K_{cli}$ = $(g^{N_{S}})^{N_{C}}$}{cli}
                    \nextlevel[2]
                }
            \end{msc}
        \end{postscript}
    }
    \caption{\opcua OpenSecureConversation sub-protocol}
    \label{fig:secure_conv_se}
\end{figure}

\begin{table}[htb]
    \centering
    \begin{tabular}{|c|c|c|c|c|c|}
        \hline
        \multicolumn{2}{|c}{\opcua Security modes} & \multicolumn{4}{|c|}{Objectives} \\
        \hline
        C              & S              & Sec $K_{cli}$ & Sec $K_{srv}$ & Auth $g^{N_{S}}$  & Auth $g^{N_{C}}$  \\
        \hline                                                                                                  
        None           & None           & \UNSAFE       & \UNSAFE       & \UNSAFE           & \UNSAFE           \\ 
        \hline                                                                                                  
        None           & Sign           & \UNSAFE       & \SAFE         & \UNSAFE           & \SAFE             \\ 
        \hline                                                                                                  
        None           & SignAndEncrypt & \UNSAFE       & \SAFE         & \UNSAFE           & \SAFE             \\ 
        \hline                                                                                                  
        Sign           & None           & \SAFE         & \UNSAFE       & \SAFE             & \UNSAFE           \\ 
        \hline                                                                                                  
        Sign           & Sign           & \SAFE         & \SAFE         & \SAFE             & \SAFE             \\ 
        \hline                                                                                                  
        Sign           & SignAndEncrypt & \SAFE         & \SAFE         & \SAFE             & \SAFE             \\ 
        \hline                                                                                                  
        SignAndEncrypt & None           & \SAFE         & \UNSAFE       & \SAFE             & \UNSAFE           \\ 
        \hline                                                                                                  
        SignAndEncrypt & Sign           & \SAFE         & \SAFE         & \SAFE             & \SAFE             \\ 
        \hline                                                                                                  
        SignAndEncrypt & SignAndEncrypt & \SAFE         & \SAFE         & \SAFE             & \SAFE             \\ 
        \hline
    \end{tabular}
    \label{tab:secure_conv_results}
    \caption{Results}
\end{table}
