%\newcommand{\csreq}{CreateSessionRequest}
%\newcommand{\csres}{CreateSessionResponse}
%\newcommand{\asreq}{ActivateSessionRequest}
%\newcommand{\asres}{ActivateSessionResponse}
\newcommand{\csreq}{CSReq}
\newcommand{\csres}{CSRes}
\newcommand{\asreq}{ASReq}
\newcommand{\asres}{ASRes}

\TODO Tags n√©cessaires pour cette section.


The \opcua {\em CreateSession} sub-protocol allows a client to send credentials
(e.g.: a login and a password) over an already created Secure Channel.
This sub-protocol is presented in Figure \ref{fig:session_se}.

\begin{figure}[htb]
    \renewcommand{\smname}{\smse}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Session creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{6\instdist}
                \setlength{\labeldist}{1.5\labeldist}

                \declinst{cli}{C}{}
                \declinst{sess}{S}{}

                \mess{\sm{\csreq, pk(C), $N_{C}$}{$K_{cli}$}{sk(C)}}{cli}{sess}
                \nextlevel[1]
                
                \action*{Validates pk(C)}{sess}
                \nextlevel[2.5]

                \mess{\sm{\csres, pk(S) $N_{S}$}{$K_{srv}$}{sk(S)}}{sess}{cli}
                \nextlevel[1]
                
                \action*{Validates pk(S)}{cli}
                \nextlevel[3]
                
                \mess{\sm{\asreq, pk(C), Login, Passwd}{$K_{cli}$}{sk(C)}}{cli}{sess}
                \nextlevel[1]
                
                \action*{Validates pk(C)}{sess}
                \nextlevel[2]

                \action*{Validates (Login, Passwd) }{sess}
                \nextlevel[2.5]

                \mess{\sm{\asres, $N_{S2}$}{$K_{src}$}{sk(S)}}{sess}{cli}
                \nextlevel[2]
            \end{msc}
        \end{postscript}
    }
    \label{fig:session_se}
    \caption{OPC-UA CreateSession sub-protocol}
\end{figure}

For this protocol, a modeling choice appears.
We can either suppose that C respects security standards and would use different
credentials for each server or suppose he will always send the same login and
password for all servers.

We first suppose that C always sends the same credentials including in a session
with the intruder (possibly a rogue server).
%Thus, once the intruder obtained C's Login/Passwd, he can mount an 
%authentication attack in another session.
Results under this assumption are presented in Table \ref{tab:session_results}.

\begin{table}[htb]
    \centering
    \begin{tabular}{|c|c|c|c|c|}
        \hline
        \multicolumn{2}{|c}{\opcua Security modes} & \multicolumn{3}{|c|}{Objectives}   \\
        \hline
        C              & S              & Sec $Creds$   & Auth $Creds$  & Auth $N_S$    \\
        \hline                                                                          
        None           & None           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        None           & Sign           & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        None           & SignAndEncrypt & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        Sign           & None           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        Sign           & Sign           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        Sign           & SignAndEncrypt & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        SignAndEncrypt & None           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        SignAndEncrypt & Sign           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        SignAndEncrypt & SignAndEncrypt & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
    \end{tabular}
    \label{tab:session_results}
    \caption{Results for \opcua {\em CreateSession} sub-protocol}
\end{table}

\subsection{Fixed version}

We apply the same fix than in OpenSecureConversation, the resulting protocol is
displayed in Figure \ref{fig:session_fix}

\begin{figure}[htb]
    \renewcommand{\smname}{\smse}
    \resizebox{\textwidth}{!}{
        \begin{postscript}
            \begin{msc}{Session creation}
                \setlength{\envinstdist}{1.5\envinstdist}
                \setlength{\instdist}{6.25\instdist}
                \setlength{\labeldist}{1.5\labeldist}

                \declinst{cli}{C}{}
                \declinst{sess}{S}{}

                \mess{\sm{\csreq, pk(C), $N_{C}$}{$K_{cli}$}{sk(C)}}{cli}{sess}
                \nextlevel[1]
                
                \action*{Validates pk(C)}{sess}
                \nextlevel[2.5]

                \mess{\sm{\csres, pk(S) $N_{S}$}{$K_{srv}$}{sk(S)}}{sess}{cli}
                \nextlevel[1]
                
                \action*{Validates pk(S)}{cli}
                \nextlevel[3]
                
                \mess{\sm{\asreq, {\bf S}, pk(C), Login, Passwd}{$K_{cli}$}{sk(C)}}{cli}{sess}
                \nextlevel[1]
                
                \action*{Validates pk(C)}{sess}
                \nextlevel[2]

                \action*{Validates (Login, Passwd) }{sess}
                \nextlevel[2.5]

                \mess{\sm{\asres, $N_{S2}$}{$K_{src}$}{sk(S)}}{sess}{cli}
                \nextlevel[2]
            \end{msc}
        \end{postscript}
    }
    \label{fig:session_fix}
    \caption{OPC-UA fixed CreateSession sub-protocol}
\end{figure}

Then authentication becomes secure as shown in Table \ref{tab:session_fix_results}.

\begin{table}[htb]
    \centering
    \begin{tabular}{|c|c|c|c|c|}
        \hline
        \multicolumn{2}{|c}{\opcua Security modes} & \multicolumn{3}{|c|}{Objectives}   \\
        \hline
        C              & S              & Sec $Creds$   & Auth $Creds$  & Auth $N_S$    \\
        \hline                                                                          
        None           & None           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        None           & Sign           & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        None           & SignAndEncrypt & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        Sign           & None           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        Sign           & Sign           & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        Sign           & SignAndEncrypt & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        SignAndEncrypt & None           & \UNSAFE       & \UNSAFE       & \TODO         \\ 
        \hline
        SignAndEncrypt & Sign           & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        SignAndEncrypt & SignAndEncrypt & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
    \end{tabular}
    \label{tab:session_fix_results}
    \caption{Results for fixed \opcua {\em CreateSession} sub-protocol}
\end{table}

In a second time, we suppose that C would use different credentials for each server.
Then both normal and fixed CreateSession results in Table \ref{tab:session_uniq_creds_results}

\begin{table}[htb]
    \centering
    \begin{tabular}{|c|c|c|c|c|}
        \hline
        \multicolumn{2}{|c}{\opcua Security modes} & \multicolumn{3}{|c|}{Objectives}   \\
        \hline
        C              & S              & Sec $Creds$   & Auth $Creds$  & Auth $N_S$    \\
        \hline                                                                          
        None           & None           & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        None           & Sign           & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        None           & SignAndEncrypt & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        Sign           & None           & \SAFE         & \SAFE         & \TODO         \\ 
        \hline
        Sign           & Sign           & \UNSAFE       & \SAFE         & \TODO         \\ 
        \hline
        Sign           & SignAndEncrypt & \SAFE         & \SAFE         & \TODO         \\ 
        \hline
        SignAndEncrypt & None           & \SAFE         & \SAFE         & \TODO         \\ 
        \hline
        SignAndEncrypt & Sign           & \SAFE         & \SAFE         & \TODO         \\ 
        \hline
        SignAndEncrypt & SignAndEncrypt & \SAFE         & \SAFE         & \TODO         \\ 
        \hline
    \end{tabular}
    \label{tab:session_uniq_creds_results}
    \caption{Results for \opcua {\em CreateSession} sub-protocol with uniq credentials}
\end{table}
